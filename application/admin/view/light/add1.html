{include file="index/header" /}
<style>
    .one-pan{
        position: relative;
    }
    .one{
        position: absolute;
        left:300px;
        top:0;
    }
</style>
<div class="layui-body">
    <div style="margin: 20px;">
    <span class="layui-breadcrumb" lay-separator=">">
        <a>一站式</a>
        <a><cite>创建订单（售前）</cite></a>
    </span>
    </div>
    <div class="layui-tab layui-tab-brief" style="margin-left: 10px;" lay-filter="docDemoTabBrief">
        <ul class="layui-tab-title">
            <li>
                <a href='<?=url("light/add")?>'>闪电租房</a>
                </li>
            <li class="layui-this">一站式</li>
        </ul>
    </div>
    <div style="margin: 10px">
        <div style="padding: 15px;">
            <form class="layui-form" action="<?=url('light/add1')?>" method="post">
                <div class="layui-form-item">
                    <label class="layui-form-label"><span style="color: red;">*</span>订单编号</label>
                    <div class="layui-input-block">
                        <input type="text" value="{$orderBid}" name="cl_order_id" lay-verify="required|title" placeholder="请输入订单编号" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">搜索客户</label>
                    <div class="layui-input-inline">
                        <select name="modules" id="users" lay-search="">
                            <option value="">直接选择客户编号</option>
                            {volist name='user' id='vo'}
                            <option value="{$vo.crm_user_bid}">{$vo.crm_user_bid}</option>
                            {/volist}
                        </select>
                    </div>
                    <div class="layui-input-inline" style="display: none">
                        <select name="modules" id="user2" lay-search="">
                            <option value="">直接选择客户编号</option>
                            {volist name='user' id='vo'}
                            <option value="{$vo.crm_user_bid}">{$vo.crm_user_bid}</option>
                            {/volist}
                        </select>
                    </div>
                    <div class="layui-input-inline">
                        <span class="layui-btn layui-btn-sm" id="addUser">添加客户</span>
                    </div>
                </div>
                <div class="layui-form-item" id="selectedUser" style="display: none">
                    <label class="layui-form-label">已选客户</label>
                    <div class="layui-input-block" id="userList">
                        <input type="hidden" id="userids" lay-verify="userReq">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">推荐人微信</label>
                    <div class="layui-input-block">
                        <input type="text" id="cl_refer_ids" name="cl_refer_ids" readonly placeholder="推荐人微信在选择客户后自动填充！不可修改" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item" pane>
                    <label class="layui-form-label"><span style="color: red;">*</span>付款时间</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" lay-verify="required"  name="cl_pay_time" readonly id="alert" placeholder="请选择付款时间">
                    </div>
                    <div class="layui-form-mid layui-word-aux" style="color:red !important;">时间为澳洲时间。</div>
                </div>
                <div class="layui-form-item" pane  id="order_price">
                    <label class="layui-form-label"><span style="color: red;">*</span>付款金额</label>
                    <div class="layui-input-inline">
                        <input type="number" class="layui-input" lay-verify="required"  name="cl_price" placeholder="$">
                    </div>
                </div>
                <div class="layui-form-item" pane>
                    <label class="layui-form-label">付款方式</label>
                    <div class="layui-input-inline">
                        <select name="cl_pay_type">
                            <option value="">请选择客户付款方式</option>
                            <option value="1">淘宝</option>
                            <option value="2">转账</option>
                            <option value="3">汇款</option>
                        </select>
                    </div>
                    <div class="layui-form-mid layui-word-aux" style="color:red !important;">客户付给我们的钱的付款方式</div>
                </div>
                <div class="layui-form-item" pane>
                    <label class="layui-form-label">付款ID</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" name="cl_pay_id" placeholder="请输入付款ID，如淘宝订单号">
                    </div>
                </div>
                <div class="layui-form-item one-pan">
                    <label class="layui-form-label">收款凭证</label>
                    <div class="layui-upload-drag" id="uploadLogo" style="display:inline-block;">
                        <image id="logoPre">
                            <input type="hidden" name="cl_pay_img" id="cl_pay_img" value=""/>
                        </image>
                        <div id="display">
                            <i class="layui-icon"></i>
                            <p>请点击此处上传图片</p>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item" pane>
                    <label class="layui-form-label"><span style="color: red;">*</span>确认需求</label>
                    <div class="layui-input-block">
                        <input type="radio" name="cl_need_confirm" lay-filter="confirm"  value="1" title="是">
                        <input type="radio" name="cl_need_confirm" lay-filter="confirm"  value="2" title="否" >
                        <input type="hidden" id="cl_need_confirm" lay-verify="radioreq">
                    </div>
                </div>
                <div class="layui-form-item" pane>
                    <label class="layui-form-label">服务协议</label>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn" id="test3"><i class="layui-icon"></i>上传文件</button>
                    </div>
                    <div class="layui-input-inline">
                        <input id="docUrl" type="text" name="cl_agreement" class="layui-input" readonly/>
                    </div>
                    <div class="layui-form-mid layui-word-aux" style="color:red !important;font-weight: bolder">服务协议仅限于PDF|XLS|XLSX</div>
                </div>
                <div class="layui-form-item" pane>
                    <label class="layui-form-label"><span style="color: red;">*</span>材料申请截止日期</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" lay-verify="required"  name="cl_end_time" readonly id="deadline" placeholder="请选择截止时间">
                    </div>
                    <div class="layui-form-mid layui-word-aux" style="color:red !important;">时间为澳洲时间。</div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">任务备注</label>
                    <div class="layui-input-block">
                        <textarea placeholder="请输入任务备注" name="cl_remarks" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="saveInfo">创建</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    layui.use(['form', 'jquery','upload','laydate','layer'], function(){
        var form = layui.form
            ,upload = layui.upload
            ,layer = layui.layer
            ,laydate = layui.laydate
            ,$ = layui.jquery;
        //alert
        laydate.render({
            elem: '#alert'
            ,type: 'date'
            ,trigger: 'click'
        });
        laydate.render({
            elem: '#deadline'
            ,type: 'date'
            ,trigger: 'click'
        });
        form.on('radio(confirm)', function (data) {
            var need = data.value;
            if(need == 1){
                $('#cl_need_confirm').val('1');
                layer.msg('请检查客户的需求是否已经确认');
            }else{
                $('#cl_need_confirm').val('2');
                layer.msg('请检查客户的需求是否已经确认');
            }
        });
        //文件
        upload.render({
            elem: '#test3'
            ,url: '{:url("admin/light/upload")}'
            ,exts: 'PDF|XLS|XLSX,'
            ,size: '100000'
            ,done: function(res){
                layer.close(layer.msg());//关闭上传提示窗口
                if(res.status == 0) {
                    return layer.msg(res.message);
                }
                console.log(res);
                $('#docUrl').val('' +res.filepath + '');
            }
        });
        //图片上传
        upload.render({
            elem: '#uploadLogo'
            ,url: '{:url("light/upload")}'
            ,size:600 //限制文件大小，单位 KB
            ,ext: 'jpg|png|gif'
            ,accept: 'images' //限制文件大小，单位 KB
            ,before: function(input){
                loading = layer.load(2, {
                    shade: [0.2,'#000']
                });
            }
            ,done: function(res){
                $('#logoPre').removeAttr('src');
                $('#cl_pay_img').val('');
                console.log(res);
                console.log(res.filepath);
                layer.close(loading);
                $('#cl_pay_img').val(res.filepath);
                $('#uploadLogo').removeClass('layui-upload-drag');
                $('#logoPre').css('width','216px');
                $('#logoPre').css('height','150px');
                $('#logoPre').attr('src',"__PUBLIC__/"+res.filepath);
                $('#display').hide();
                layer.msg(res.msg, {icon: 1, time: 1000});
            }
            ,error: function(res){
                layer.msg(res.msg, {icon: 2, time: 1000});
            }
        });
        form.verify({
            title: function(value){
                if(value.length < 2){
                    return '至少得2个字符啊';
                }
            },radioreq:function (value) {
                var need = $("#cl_need_confirm").val();
                if(need  != 1){
                    return '请检查客户的需求是否已经确认!';
                }
            },userReq:function (value) {
                var need = $(".userid").length;
                if(need  <= 0){
                    return '请至少添加一个客户！';
                }
            }
        });
        $('#addUser').click(function () {
            var user = $('#users').val();
            if(!user){
                layer.alert('请至少选择一个客户', {
                    skin: 'layui-layer-molv'
                    ,closeBtn: 0
                });
            }else{
                $('#selectedUser').show();
                var html = '<lable class="userss"><span style="margin-left: 15px;" class="layui-btn layui-btn-xs layui-btn-normal">'+user+'</span><i  class="close layui-icon"></i><input type="hidden" class="userid" name="cl_user_ids[]" lay-verify="userReq" value='+user+' /></lable>';
                $('#userList').append(html);
                $("#users").empty();
                var option = $('#user2').html();
                $("#users").append(option);
                form.render("select");

                $.ajax({
                    type: 'GET',
                    url: "<?=url('light/userRefer')?>?user_bid="+user,
                    dataType:  'json',
                    success: function(data){
                        console.log(data);
                        if(data.code == 1){
                            var vaalus = $('#cl_refer_ids').val();
                            if(vaalus.length>0){
                                $('#cl_refer_ids').val(vaalus+','+data.data);
                            }else{
                                $('#cl_refer_ids').val(data.data);
                            }
                        }
                    }
                });
            }
        });
    });
    $("body").on("click",".close",function(){
        $(this).parents(".userss").remove();
    });
</script>
{include file="index/footer" /}